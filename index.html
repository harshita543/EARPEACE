<script>
    // --- Initialization and State ---
    const audio = new Audio();
    let isPlaying = false;
    let currentTrackIndex = 0;
    
    // Placeholder tracks using external URLs since local files cannot be embedded.
    // NOTE: The local file uploaded by the user will be prepended to this list.
    const playlist = [
        { title: "Ocean Breeze", artist: "Placeholder Track 1", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3", isPlaceholder: true },
        { title: "Ambient Journey", artist: "Placeholder Track 2", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3", isPlaceholder: true },
        { title: "Cinematic Build-up", artist: "Placeholder Track 3", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3", isPlaceholder: true }
    ];

    // --- DOM Elements (omitted for brevity) ---
    // ... (Your existing DOM element definitions)
    const songTitleEl = document.getElementById('song-title');
    const songArtistEl = document.getElementById('song-artist');
    const playPauseBtn = document.getElementById('play-pause-btn');
    const playIcon = document.getElementById('play-icon');
    const pauseIcon = document.getElementById('pause-icon');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const currentTimeEl = document.getElementById('current-time');
    const durationEl = document.getElementById('duration');
    const progressBarContainer = document.getElementById('progress-bar-container');
    const progressBar = document.getElementById('progress-bar');
    const fileInput = document.getElementById('audio-file-input');
    const fileStatusEl = document.getElementById('file-status');
    const albumIcon = document.getElementById('album-icon');
    const volumeSlider = document.getElementById('volume-slider');


    // --- Helper Functions (omitted for brevity) ---
    // ... (Your existing formatTime function)
    function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
    }

    // ... (Your existing updateUI function)
    function updateUI(track) {
        songTitleEl.textContent = track.title;
        songArtistEl.textContent = track.artist;
        // Reset progress bar display
        currentTimeEl.textContent = '0:00';
        durationEl.textContent = '0:00';
        progressBar.style.width = '0%';
    }

    // --- Core Player Functions (omitted for brevity) ---
    // ... (Your existing loadTrack, togglePlayPause, nextTrack, prevTrack, updatePlayPauseIcon functions)
    function loadTrack(track) {
        audio.src = track.src;
        audio.load();
        updateUI(track);
        
        // Show album icon for placeholder tracks, hide otherwise
        if (track.isPlaceholder) {
            albumIcon.classList.remove('hidden');
        } else {
            albumIcon.classList.add('hidden'); 
        }
    }

    function togglePlayPause() {
        if (audio.paused) {
            audio.play().catch(error => {
                console.error("Autoplay failed or player not ready:", error);
                fileStatusEl.textContent = "Playback blocked. Please interact with the player first.";
            });
        } else {
            audio.pause();
        }
        isPlaying = !audio.paused;
        updatePlayPauseIcon();
    }

    function nextTrack() {
        currentTrackIndex = (currentTrackIndex + 1) % playlist.length;
        loadTrack(playlist[currentTrackIndex]);
        if (isPlaying) {
            audio.play();
        }
    }

    function prevTrack() {
        currentTrackIndex = (currentTrackIndex - 1 + playlist.length) % playlist.length;
        loadTrack(playlist[currentTrackIndex]);
        if (isPlaying) {
            audio.play();
        }
    }

    function updatePlayPauseIcon() {
        if (isPlaying) {
            playIcon.style.display = 'none';
            pauseIcon.style.display = 'block';
        } else {
            playIcon.style.display = 'block';
            pauseIcon.style.display = 'none';
        }
    }


    // --- Event Listeners and Audio Handling ---

    // 1. Play/Pause Button
    playPauseBtn.addEventListener('click', togglePlayPause);
    
    // 2. Next/Previous Buttons
    nextBtn.addEventListener('click', nextTrack);
    prevBtn.addEventListener('click', prevTrack);

    // 3. Audio Time Updates (updates progress bar and time display)
    audio.addEventListener('timeupdate', () => {
        const duration = audio.duration;
        const currentTime = audio.currentTime;

        if (isFinite(duration) && duration > 0) {
            const progressPercent = (currentTime / duration) * 100;
            progressBar.style.width = `${progressPercent}%`;
            currentTimeEl.textContent = formatTime(currentTime);
        }
    });

    // 4. Audio Metadata Loaded (updates duration once metadata is available)
    audio.addEventListener('loadedmetadata', () => {
        if (isFinite(audio.duration)) {
            durationEl.textContent = formatTime(audio.duration);
        }
    });

    // 5. Audio Ended (automatically plays next track)
    audio.addEventListener('ended', nextTrack);

    // 6. Progress Bar Click (allows seeking)
    progressBarContainer.addEventListener('click', (e) => {
        const width = progressBarContainer.clientWidth;
        const clickX = e.offsetX;
        const duration = audio.duration;
        
        if (isFinite(duration) && duration > 0) {
            audio.currentTime = (clickX / width) * duration;
        }
    });

    // 7. Volume Slider
    volumeSlider.addEventListener('input', (e) => {
        audio.volume = e.target.value;
    });

    // 8. FILE INPUT CHANGE (***THE CORRECTED PART***)
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];

        if (file) {
            // Revoke any previous URL to clean up memory
            if (playlist[currentTrackIndex] && playlist[currentTrackIndex].objectURL) {
                URL.revokeObjectURL(playlist[currentTrackIndex].objectURL);
            }

            const objectURL = URL.createObjectURL(file);
            const fileName = file.name;
            const trackName = fileName.substring(0, fileName.lastIndexOf('.')) || fileName; // Remove file extension
            
            const newTrack = {
                title: trackName,
                artist: 'Local File',
                src: objectURL,
                isPlaceholder: false,
                objectURL: objectURL // Keep a reference to revoke later
            };

            // Replace the first item in the playlist (or prepend) with the new track
            // Prepending ensures the loaded track is the one that gets played.
            if (playlist.length > 0 && playlist[0].objectURL) {
                // If the first track is a previously loaded local file, replace it.
                playlist[0] = newTrack;
            } else if (playlist.length > 0 && !playlist[0].isPlaceholder) {
                // If it's a different local file, replace it.
                playlist[0] = newTrack;
            } else {
                 // Otherwise, insert the new track at the beginning
                playlist.unshift(newTrack); 
            }
            
            currentTrackIndex = 0; // Set index to the newly loaded track
            loadTrack(playlist[currentTrackIndex]);
            fileStatusEl.textContent = `File loaded: ${fileName}`;
            
            // Start playing the new track
            audio.play().catch(error => {
                 console.error("Autoplay failed:", error);
                 fileStatusEl.textContent = "Playback started, but was blocked. Click play to begin.";
                 isPlaying = false;
                 updatePlayPauseIcon();
            });
            isPlaying = true;
            updatePlayPauseIcon();
        } else {
            fileStatusEl.textContent = "No file loaded.";
        }
    });

    // --- Initial Load ---
    loadTrack(playlist[currentTrackIndex]);
    updatePlayPauseIcon(); // Set initial icon state to 'Play'
    fileStatusEl.textContent = 'Ready to load or play placeholder track.';

</script>
