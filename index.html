<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EarPeace: Advanced Music Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Custom styles for progress bar and volume slider thumb */
        #progress-bar-container { height: 8px; background-color: #374151; border-radius: 9999px; cursor: pointer; }
        #progress-bar { height: 100%; width: 0%; background-color: #0EA5E9; border-radius: 9999px; transition: width 0.1s linear; }
        body { font-family: 'Inter', sans-serif; }
        #audio-file-input { width: 0.1px; height: 0.1px; opacity: 0; overflow: hidden; position: absolute; z-index: -1; }
        #play-pause-btn svg { transition: transform 0.2s; }
        #play-pause-btn:hover svg { transform: scale(1.1); }
        #volume-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 14px; height: 14px; border-radius: 50%; background: #0EA5E9; cursor: pointer; }
        #volume-slider::-moz-range-thumb { width: 14px; height: 14px; border: 0; border-radius: 50%; background: #0EA5E9; cursor: pointer; }
        
        /* Two-column layout using CSS Grid (Adjusted for 2 columns since Reverb/Lyrics are now combined) */
        .grid-container {
            display: grid;
            grid-template-columns: 1fr 3fr; /* Sidebar, Player */
            gap: 1.5rem;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-4">

    <div class="grid-container w-full max-w-5xl">

        <aside id="sidebar" class="bg-gray-800 p-4 rounded-xl shadow-2xl overflow-y-auto max-h-[80vh]">
            <h2 class="text-xl font-bold mb-4 text-sky-400">üé∂ Playlist</h2>
            <div id="playlist-list" class="space-y-2">
                </div>
            <h2 class="text-xl font-bold mt-6 mb-4 text-pink-400">‚ù§ Favorites</h2>
            <div id="favorites-list" class="space-y-2">
                <p class="text-xs text-gray-500 italic">No favorites yet.</p>
            </div>
        </aside>

        <div id="player-container" class="w-full bg-gray-800 p-8 rounded-2xl shadow-2xl transition-all duration-300">
            <h1 class="text-3xl font-extrabold mb-6 text-center text-sky-400">EarPeace Advanced</h1>

            <div class="mb-6 flex flex-col items-center">
                <input type="file" id="audio-file-input" accept="audio/*">
                <label for="audio-file-input" class="cursor-pointer bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-6 rounded-xl shadow-lg transition duration-300 text-sm md:text-base">
                    Load Your Own MP3
                </label>
                <p id="file-status" class="mt-2 text-xs text-gray-400 italic">Ready to load or play placeholder track.</p>
            </div>

            <div class="w-48 h-48 mx-auto bg-gray-700 rounded-xl mb-6 flex items-center justify-center shadow-inner overflow-hidden">
                <svg id="album-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-24 h-24 text-gray-500">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 9l10.5-3m0 6l-4.5 4.5M21 9v10.5a2.25 2.25 0 01-2.25 2.25H4.5a2.25 2.25 0 01-2.25-2.25V9m19.5-3a2.25 2.25 0 00-2.25-2.25H6.375a2.25 2.25 0 00-2.25 2.25M9 12.75h.008v.008H9v-.008zm.008 3.75H9v.008h.008v-.008zm2.25-5.625h.008v.008h-.008v-.008z" />
                </svg>
            </div>
            
            <div class="text-center mb-6">
                <p id="song-title" class="text-xl font-bold truncate">Welcome to EarPeace!</p>
                <p id="song-artist" class="text-sm text-gray-400">Load a song or play a placeholder track.</p>
            </div>

            <div class="mb-4">
                <div id="progress-bar-container">
                    <div id="progress-bar"></div>
                </div>
                <div class="flex justify-between text-xs mt-2 text-gray-400">
                    <span id="current-time">0:00</span>
                    <span id="duration">0:00</span>
                </div>
            </div>

            <div class="flex justify-center items-center space-x-6">
                <button id="prev-btn" class="text-gray-400 hover:text-sky-400 p-2 rounded-full transition duration-150" aria-label="Previous Track">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path fill-rule="evenodd" d="M20.25 4.5a.75.75 0 01.75.75v14.75a.75.75 0 01-1.5 0V12h-4.5v7.5a.75.75 0 01-1.5 0v-7.5H5.25v7.5a.75.75 0 01-1.5 0v-15a.75.75 0 011.5 0V9h4.5V4.5a.75.75 0 011.5 0V9h4.5V4.5a.75.75 0 01.75-.75z" clip-rule="evenodd" />
                    </svg>
                </button>

                <button id="play-pause-btn" class="relative bg-sky-500 hover:bg-sky-600 p-4 rounded-full shadow-lg shadow-sky-500/50 transition duration-300 transform active:scale-95" aria-label="Play or Pause">
                    <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 text-white transition-opacity duration-200">
                        <path fill-rule="evenodd" d="M4.5 5.653c0-1.426 1.529-2.38 2.872-1.628l11.474 6.153a1.125 1.125 0 010 2.016l-11.474 6.153a1.125 1.125 0 01-1.638-.75V5.653z" clip-rule="evenodd" />
                    </svg>
                    <svg id="pause-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 text-white absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 opacity-0 transition-opacity duration-200" style="display: none;">
                        <path fill-rule="evenodd" d="M6.75 5.25a.75.75 0 01.75-.75H9a.75.75 0 01.75.75v13.5a.75.75 0 01-.75.75H7.5a.75.75 0 01-.75-.75V5.25zm7.5 0A.75.75 0 0115 4.5h1.5a.75.75 0 01.75.75v13.5a.75.75 0 01-.75.75H15a.75.75 0 01-.75-.75V5.25z" clip-rule="evenodd" />
                    </svg>
                </button>
                
                <button id="next-btn" class="text-gray-400 hover:text-sky-400 p-2 rounded-full transition duration-150" aria-label="Next Track">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path fill-rule="evenodd" d="M4.5 4.5A.75.75 0 015.25 3h13.5a.75.75 0 01.75.75v15a.75.75 0 01-.75.75H5.25a.75.75 0 01-.75-.75V4.5zm5.56 9.47a.75.75 0 010-1.06l3.75-3.75a.75.75 0 011.06 0l3.75 3.75a.75.75 0 01-1.06 1.06l-3.22-3.22-3.22 3.22a.75.75 0 01-1.06 0z" clip-rule="evenodd" />
                        <path d="M12 9.75a.75.75 0 01.75-.75h.008a.75.75 0 01.75.75v.008a.75.75 0 01-.75.75H12.75a.75.75 0 01-.75-.75V9.75z" />
                    </svg>
                </button>
            </div>
            
            <div class="flex items-center space-x-4 mt-6 pt-4 border-t border-gray-700">
                <svg id="volume-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 text-gray-400">
                    <path d="M13.5 4.062c0-1.426-1.529-2.38-2.872-1.628L6.928 4.903A.75.75 0 006 5.438v13.5c0 .535.45.968.928 1.104l3.7-.872a.75.75 0 00.573-.243 45.45 45.45 0 00.354-.383l4.595-4.041c1.242-1.096 1.258-2.923.047-4.032l-4.595-4.041a.75.75 0 00-.354-.383l-3.7-.872A1.5 1.5 0 0013.5 4.062z" />
                    <path d="M18.75 14.25c0 1.242-.705 2.298-1.756 2.766a3.501 3.501 0 01-3.955-.136L9.75 13.5V11.25l3.394-2.827a3.501 3.501 0 013.955-.136C18.045 9.952 18.75 11.008 18.75 12.25v2.001z" />
                </svg>
                <input type="range" id="volume-slider" min="0" max="1" step="0.05" value="1" class="w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-sky-500">
            </div>

            <div class="mt-6 flex justify-center">
                <button id="add-to-fav-btn" class="flex items-center space-x-2 bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 px-4 rounded-xl transition duration-300 transform active:scale-95 text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                        <path d="M11.645 20.91l-.007-.003-.021-.005A17.917 17.917 0 0112 20.521c.176.012.35.022.525.033.01.002.02.003.03.006l.006.002 10.14-5.666a1.5 1.5 0 00-.368-2.585L14.735 9.42l3.433-6.526a1.5 1.5 0 00-.323-2.122l-1.658-.925a1.5 1.5 0 00-2.023.235l-3.324 3.324-1.66-3.325a1.5 1.5 0 00-2.73-.243l-3.79 3.79-.523.522-3.41-3.41a1.5 1.5 0 00-2.121 2.122l3.41 3.41 1.66 3.325a1.5 1.5 0 002.73.243l3.324-3.324 1.658.925a1.5 1.5 0 002.023-.235l3.324-3.324 1.66 3.325a1.5 1.5 0 002.73.243l3.79-3.79.523-.522z" />
                    </svg>
                    <span>Add to Favorites</span>
                </button>
            </div>
            
            <section id="lyrics-section" class="mt-8 pt-4 border-t border-gray-700">
                <h2 class="text-xl font-bold mb-4 text-sky-400 text-center">üìù Lyrics</h2>
                <div id="lyrics-content" class="text-gray-300 text-sm leading-relaxed max-h-48 overflow-y-auto p-2 bg-gray-700 rounded-lg">
                    <p>No song loaded or lyrics unavailable.</p>
                    <p class="mt-4 italic text-gray-500">Lyrics integration typically requires fetching data from an external API, which is not possible in this local snippet. Placeholder lyrics are displayed for the sample tracks.</p>
                </div>
            </section>
        </div>
        
    </div>
    
    <script>
        // --- Initialization and State ---
        const audio = new Audio();
        let isPlaying = false;
        let currentTrackIndex = 0;
        
        // Web Audio API Context and Nodes for Volume Control ONLY (Reverb removed)
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        let sourceNode; // The source of the audio (connects to the <audio> element)
        let masterGainNode; // For the master volume control

        // Placeholder tracks. Added a 'isFavorite' flag and sample lyrics.
        const playlist = [
            { title: "Ocean Breeze", artist: "Placeholder Track 1", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3", isPlaceholder: true, isLocalTemp: false, isFavorite: false, lyrics: "The waves roll in and the tide goes out.\nA gentle rhythm, free from doubt.\nFeel the sand beneath your feet,\nThis ambient journey is oh so sweet." },
            { title: "Ambient Journey", artist: "Placeholder Track 2", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3", isPlaceholder: true, isLocalTemp: false, isFavorite: true, lyrics: "A quiet moment, a peaceful space.\nLost in the sound, finding grace.\nListen closely to the low drone,\nIn this vast world, you are not alone." },
            { title: "Cinematic Build-up", artist: "Placeholder Track 3", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3", isPlaceholder: true, isLocalTemp: false, isFavorite: false, lyrics: "The drums begin to escalate,\nA sense of destiny, sealed by fate.\nThe strings rise high, a powerful sound,\nThis is the moment, solid ground." }
        ];

        // --- DOM Elements ---
        const songTitleEl = document.getElementById('song-title');
        const songArtistEl = document.getElementById('song-artist');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const playIcon = document.getElementById('play-icon');
        const pauseIcon = document.getElementById('pause-icon');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const currentTimeEl = document.getElementById('current-time');
        const durationEl = document.getElementById('duration');
        const progressBarContainer = document.getElementById('progress-bar-container');
        const progressBar = document.getElementById('progress-bar');
        const fileInput = document.getElementById('audio-file-input');
        const fileStatusEl = document.getElementById('file-status');
        const albumIcon = document.getElementById('album-icon');
        const volumeSlider = document.getElementById('volume-slider');
        const playlistListEl = document.getElementById('playlist-list');
        const favoritesListEl = document.getElementById('favorites-list');
        const addToFavBtn = document.getElementById('add-to-fav-btn');
        const lyricsContentEl = document.getElementById('lyrics-content');


        // --- Helper Functions ---
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
        }
        
        function renderPlaylist() {
            playlistListEl.innerHTML = '';
            favoritesListEl.innerHTML = '';
            
            let favoriteCount = 0;

            playlist.forEach((track, index) => {
                // Skip the temporary local file if it's not the currently playing track
                if (track.isLocalTemp && index !== currentTrackIndex) return;

                const item = document.createElement('div');
                item.className = `flex justify-between items-center p-2 rounded-lg cursor-pointer transition duration-150 ${index === currentTrackIndex ? 'bg-sky-700 font-bold' : 'hover:bg-gray-700'}`;
                item.innerHTML = `
                    <span class="text-sm truncate">${track.title}</span>
                `;
                item.addEventListener('click', () => {
                    currentTrackIndex = index;
                    loadTrack(playlist[currentTrackIndex]);
                    togglePlayPause(true); 
                });
                
                playlistListEl.appendChild(item);
                
                if (track.isFavorite) {
                    const favItem = document.createElement('div');
                    favItem.className = 'p-2 rounded-lg text-sm truncate cursor-pointer hover:bg-gray-700';
                    favItem.textContent = `${track.title} (${track.artist})`;
                    favItem.addEventListener('click', () => {
                        currentTrackIndex = index;
                        loadTrack(playlist[currentTrackIndex]);
                        togglePlayPause(true); 
                    });
                    favoritesListEl.appendChild(favItem);
                    favoriteCount++;
                }
            });
            
            if (favoriteCount === 0) {
                favoritesListEl.innerHTML = '<p class="text-xs text-gray-500 italic">No favorites yet. Click the heart button!</p>';
            }
        }
        
        function updateUI(track) {
            songTitleEl.textContent = track.title;
            songArtistEl.textContent = track.artist;
            currentTimeEl.textContent = '0:00';
            durationEl.textContent = '0:00';
            progressBar.style.width = '0%';
            
            // Show icon if it's a placeholder or temporary local file
            if (track.isPlaceholder || track.isLocalTemp) {
                albumIcon.classList.remove('hidden');
            } else {
                albumIcon.classList.add('hidden'); 
            }
            
            // Update Favorites button state
            addToFavBtn.classList.toggle('bg-red-600', track.isFavorite);
            addToFavBtn.classList.toggle('bg-pink-600', !track.isFavorite);
            addToFavBtn.querySelector('span').textContent = track.isFavorite ? 'Remove from Favorites' : 'Add to Favorites';
            
            // Update Lyrics column
            lyricsContentEl.innerHTML = track.lyrics.replace(/\n/g, '<br>');
            
            renderPlaylist(); 
        }


        // --- Core Player Functions ---
        
        // Initialize Web Audio API nodes for volume control
        function initWebAudio() {
            if (!sourceNode) {
                // Connect the HTML audio element to the AudioContext
                sourceNode = audioContext.createMediaElementSource(audio);
                
                // Create a master gain node
                masterGainNode = audioContext.createGain(); 

                // Connect the chain: Source -> Master Gain -> Destination
                sourceNode.connect(masterGainNode);
                masterGainNode.connect(audioContext.destination);

                // Set initial volume
                masterGainNode.gain.value = volumeSlider.value;
            }
        }
        
        function loadTrack(track) {
            audio.src = track.src;
            audio.load();
            updateUI(track);
        }

        // Toggles play/pause, with a forcePlay option for track changes
        function togglePlayPause(forcePlay = false) {
            // CRITICAL FIX: Resume AudioContext on user interaction
            if (audioContext.state === 'suspended') {
                audioContext.resume().catch(error => console.error("Failed to resume AudioContext:", error));
            }
            
            if (audio.paused || forcePlay) {
                initWebAudio(); // Initialize audio chain
                audio.play().then(() => {
                    isPlaying = true;
                    updatePlayPauseIcon();
                }).catch(error => {
                    console.error("Autoplay failed or player not ready:", error);
                    fileStatusEl.textContent = "Playback blocked. Please click play to begin.";
                });
            } else {
                audio.pause();
                isPlaying = false;
                updatePlayPauseIcon();
            }
        }

        function nextTrack() {
            currentTrackIndex = (currentTrackIndex + 1) % playlist.length;
            loadTrack(playlist[currentTrackIndex]);
            if (isPlaying) {
                togglePlayPause(true); 
            }
        }

        function prevTrack() {
            currentTrackIndex = (currentTrackIndex - 1 + playlist.length) % playlist.length;
            loadTrack(playlist[currentTrackIndex]);
            if (isPlaying) {
                togglePlayPause(true); 
            }
        }

        function updatePlayPauseIcon() {
            if (isPlaying) {
                playIcon.style.display = 'none';
                pauseIcon.style.display = 'block';
            } else {
                playIcon.style.display = 'block';
                pauseIcon.style.display = 'none';
            }
        }
        
        function toggleFavorite() {
            const currentTrack = playlist[currentTrackIndex];
            currentTrack.isFavorite = !currentTrack.isFavorite;
            updateUI(currentTrack);
        }


        // --- Event Listeners and Audio Handling ---

        playPauseBtn.addEventListener('click', () => togglePlayPause());
        nextBtn.addEventListener('click', nextTrack);
        prevBtn.addEventListener('click', prevTrack);
        addToFavBtn.addEventListener('click', toggleFavorite);
        
        // Remove the reverb slider listener

        audio.addEventListener('timeupdate', () => {
            const duration = audio.duration;
            const currentTime = audio.currentTime;

            if (isFinite(duration) && duration > 0) {
                const progressPercent = (currentTime / duration) * 100;
                progressBar.style.width = `${progressPercent}%`;
                currentTimeEl.textContent = formatTime(currentTime);
            }
        });

        audio.addEventListener('loadedmetadata', () => {
            if (isFinite(audio.duration)) {
                durationEl.textContent = formatTime(audio.duration);
            }
        });

        audio.addEventListener('ended', nextTrack);

        progressBarContainer.addEventListener('click', (e) => {
            const width = progressBarContainer.clientWidth;
            const clickX = e.offsetX;
            const duration = audio.duration;
            
            if (isFinite(duration) && duration > 0) {
                audio.currentTime = (clickX / width) * duration;
            }
        });

        volumeSlider.addEventListener('input', (e) => {
            const volume = parseFloat(e.target.value);
            audio.volume = volume; // Control HTML5 audio volume as a fallback/redundancy
            
            if (masterGainNode) {
                // Control volume via the Web Audio master gain node
                masterGainNode.gain.value = volume;
            }
        });

        // CRITICAL FIX: File upload logic with cleanup and auto-play
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];

            if (file) {
                // 1. CLEANUP: Remove old temporary local files from the playlist and revoke their URLs
                const initialLength = playlist.length;
                for (let i = initialLength - 1; i >= 0; i--) {
                    if (playlist[i].isLocalTemp) {
                        URL.revokeObjectURL(playlist[i].src); 
                        playlist.splice(i, 1);
                    }
                }
                
                const objectURL = URL.createObjectURL(file);
                const fileName = file.name;
                const trackName = fileName.substring(0, fileName.lastIndexOf('.')) || fileName; 
                
                const newTrack = {
                    title: trackName,
                    artist: 'Local File',
                    src: objectURL,
                    isPlaceholder: false,
                    isLocalTemp: true, // Mark as temporary local file
                    isFavorite: false,
                    lyrics: `Local file: ${fileName}.\nNo lyrics available.`,
                    objectURL: objectURL 
                };

                // 2. Insert the new local track at the beginning
                playlist.unshift(newTrack); 
                currentTrackIndex = 0; 
                
                loadTrack(playlist[currentTrackIndex]);
                fileStatusEl.textContent = `File loaded: ${fileName}`;
                
                // 3. Force Playback and resume AudioContext
                togglePlayPause(true); 
            } else {
                fileStatusEl.textContent = "No file selected.";
            }
        });

        // --- Initial Load ---
        loadTrack(playlist[currentTrackIndex]);
        updatePlayPauseIcon();
    </script>
</body>
</html>
